---
# Demote a node back to standby.
# Run this against the old primary after failover, once the new primary is stable.
#
# Usage:
#   ansible-playbook demote.yml -l primary-vps  # or whichever host to demote
#   ansible-playbook demote.yml -l primary-vps -e init_standby_pg=true
#
# Pass -e init_standby_pg=true to wipe Postgres and re-init as streaming replica.

- name: Demote node to standby
  hosts: all
  become: true
  vars:
    init_standby_pg: false

  tasks:
    - name: Stop all containers
      shell: >
        cd {{ vps_git_dir }}/stack &&
        docker compose --env-file .env --profile primary --profile standby down
      ignore_errors: true

    - name: Switch .env to standby mode
      lineinfile:
        path: "{{ vps_git_dir }}/stack/.env"
        regexp: "{{ item.re }}"
        line: "{{ item.line }}"
      loop:
        - { re: '^ROLE=', line: 'ROLE=standby' }
        - { re: '^COMPOSE_PROFILES=', line: 'COMPOSE_PROFILES=standby' }

    - name: Re-initialize Postgres as streaming replica
      shell: |
        docker volume rm stack_postgres_data 2>/dev/null || true
        docker volume create stack_postgres_data
        docker run --rm --network host \
          -v stack_postgres_data:/target \
          -e PGPASSWORD="{{ repl_password }}" \
          postgres:16-alpine \
          pg_basebackup -h "{{ peer_host }}" -U "{{ repl_user }}" -D /target -Fp -Xs -P -R
      when: init_standby_pg | bool

    - name: Start standby stack
      shell: >
        cd {{ vps_git_dir }}/stack &&
        COMPOSE_PROFILES=standby
        docker compose --env-file .env up -d

    - name: Node demoted
      debug:
        msg: "This node is now a standby. Postgres is replicating from the current primary."
