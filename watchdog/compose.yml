# Watchdog stack -- monitoring + automatic failover.
# Runs locally or on any 3rd machine with network access to both VPS nodes.
#
# docker compose --env-file .env up -d
# docker compose --env-file .env run --rm setup-kuma   # first-time monitor setup

services:

  kuma:
    image: louislam/uptime-kuma:1
    container_name: vps-git-kuma
    restart: unless-stopped
    volumes:
      - kuma_data:/app/data
    ports:
      - "127.0.0.1:3001:3001"

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: vps-git-status-tunnel
    restart: unless-stopped
    depends_on:
      - kuma
    command: >-
      tunnel --no-autoupdate
      --config /etc/cloudflared/config.yml
      run
    volumes:
      - ./cloudflared:/etc/cloudflared:ro

  failover:
    build: ./failover
    container_name: vps-git-failover
    restart: unless-stopped
    environment:
      PRIMARY_HEALTH_URL: ${PRIMARY_HEALTH_URL}
      CHECK_INTERVAL: ${CHECK_INTERVAL:-30}
      FAIL_THRESHOLD: ${FAIL_THRESHOLD:-3}
      ANSIBLE_PLAYBOOK: /ansible/promote.yml
      ANSIBLE_INVENTORY: /ansible/inventory.yml
    volumes:
      - ${SSH_KEY_PRIMARY}:/root/.ssh/primary_key:ro
      - ${SSH_KEY_STANDBY}:/root/.ssh/standby_key:ro
      - ../ansible:/ansible:ro

  setup-kuma:
    build: ./setup-kuma
    container_name: vps-git-setup-kuma
    profiles: ["setup"]
    depends_on:
      - kuma
    network_mode: "service:kuma"
    environment:
      KUMA_URL: http://localhost:3001
      KUMA_USERNAME: ${KUMA_USERNAME:-admin}
      KUMA_PASSWORD: ${KUMA_PASSWORD}
      HEALTH_URL: ${PRIMARY_HEALTH_URL}
      PRIMARY_HOST: ${PRIMARY_NETBIRD_IP}
      STANDBY_HOST: ${STANDBY_NETBIRD_IP}

volumes:
  kuma_data:
